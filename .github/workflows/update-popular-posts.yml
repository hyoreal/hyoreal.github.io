name: Update Popular Posts

on:
  schedule:
    # ë§¤ì¼ í•œêµ­ì‹œê°„ ì˜¤ì „ 6ì‹œ (UTC 21:00)
    - cron: '0 21 * * *'
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

permissions:
  contents: write
  pull-requests: write

jobs:
  update-popular-posts:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install @google-analytics/data

      - name: Fetch popular posts from GA4
        env:
          GA4_PROPERTY_ID: ${{ secrets.GA4_PROPERTY_ID }}
          GOOGLE_SERVICE_ACCOUNT_KEY: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_KEY }}
        run: |
          node << 'EOF'
          const { BetaAnalyticsDataClient } = require('@google-analytics/data');
          const fs = require('fs');

          async function main() {
            const credentials = JSON.parse(process.env.GOOGLE_SERVICE_ACCOUNT_KEY);
            const analyticsDataClient = new BetaAnalyticsDataClient({ credentials });
            const propertyId = process.env.GA4_PROPERTY_ID;

            const [response] = await analyticsDataClient.runReport({
              property: `properties/${propertyId}`,
              dateRanges: [{ startDate: '30daysAgo', endDate: 'today' }],
              dimensions: [{ name: 'pagePath' }, { name: 'pageTitle' }],
              metrics: [{ name: 'screenPageViews' }],
              orderBys: [{ metric: { metricName: 'screenPageViews' }, desc: true }],
              limit: 20,
            });

            const popularPosts = response.rows
              .filter(row => row.dimensionValues[0].value.startsWith('/posts/'))
              .slice(0, 5)
              .map(row => ({
                url: row.dimensionValues[0].value,
                title: row.dimensionValues[1].value.replace(' | hyoreal', ''),
                views: parseInt(row.metricValues[0].value, 10)
              }));

            fs.writeFileSync(
              '_data/popular-posts.json',
              JSON.stringify(popularPosts, null, 2)
            );

            console.log('Popular posts updated:', popularPosts);
          }

          main().catch(err => {
            console.error('Error fetching GA4 data:', err);
            process.exit(1);
          });
          EOF

      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: update popular posts data'
          title: 'ğŸ”„ Update Popular Posts Data'
          body: |
            ìë™ ìƒì„±ëœ PRì…ë‹ˆë‹¤.
            GA4ì—ì„œ ìµœê·¼ 30ì¼ê°„ ì¡°íšŒìˆ˜ ê¸°ì¤€ ì¸ê¸° ê²Œì‹œê¸€ Top 5ë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
          branch: update-popular-posts
          delete-branch: true

      - name: Check PR status
        run: |
          echo "PR Number: ${{ steps.cpr.outputs.pull-request-number }}"
          echo "PR Operation: ${{ steps.cpr.outputs.pull-request-operation }}"
          echo "PR URL: ${{ steps.cpr.outputs.pull-request-url }}"

      - name: Enable auto-merge
        if: steps.cpr.outputs.pull-request-number
        run: gh pr merge --auto --squash "${{ steps.cpr.outputs.pull-request-number }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
