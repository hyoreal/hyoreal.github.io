<!--
  Jekyll Simple Search loader
  See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->

{% capture result_elem %}
<div class="search-result-card">
  <h1><a href="{url}">{title}</a></h1>
  <div class="post-content">
    <p>{snippet}</p>
  </div>
  <div class="post-meta text-muted d-flex">
    <div class="mr-auto">
      <i class="far fa-calendar fa-fw"></i>
      <em>{date}</em>
      {categories}
      {tags}
    </div>
  </div>
</div>
{% endcapture %}

{% capture not_found %}<p class="mt-5">{{ site.data.locales[site.lang].search.no_results }}</p>{% endcapture %}

<script src="{{ site.data.assets[origin].search.js | relative_url }}"></script>

<script>
  var searchInstance = SimpleJekyllSearch({
    searchInput: document.getElementById('search-input'),
    resultsContainer: document.getElementById('search-results'),
    json: '{{ "/assets/js/data/search.json" | relative_url }}',
    searchResultTemplate: '{{ result_elem | strip_newlines }}',
    noResultsText: '{{ not_found }}',
    templateMiddleware: function (prop, value, template) {
      var searchInput = document.getElementById('search-input');
      var query = searchInput ? searchInput.value.trim() : '';

      function highlightText(text, query) {
        if (!query || query.length < 2) return text;
        var escaped = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        var regex = new RegExp('(' + escaped + ')', 'gi');
        return text.replace(regex, '<mark>$1</mark>');
      }

      function formatDate(dateStr) {
        if (!dateStr) return '';
        var date = new Date(dateStr);
        var options = { year: 'numeric', month: 'short', day: 'numeric' };
        return date.toLocaleDateString('ko-KR', options);
      }

      if (prop === 'title') {
        return highlightText(value, query);
      }

      if (prop === 'snippet') {
        return highlightText(value, query);
      }

      if (prop === 'date') {
        return formatDate(value);
      }

      if (prop === 'categories') {
        if (value === '') {
          return '';
        } else {
          return `<i class="far fa-folder-open fa-fw"></i><span>${highlightText(value, query)}</span>`;
        }
      }

      if (prop === 'tags') {
        if (value === '') {
          return '';
        } else {
          return `<i class="fa fa-tag fa-fw"></i><span>${highlightText(value, query)}</span>`;
        }
      }
    }
  });

  (function () {
    const sidebarInput = document.getElementById('sidebar-search-input');
    const mainInput = document.getElementById('search-input');
    const resultWrapper = document.getElementById('search-result-wrapper');
    const mainContent = document.getElementById('main');
    const searchHints = document.getElementById('search-hints');

    if (sidebarInput && mainInput) {
      sidebarInput.addEventListener('input', function () {
        mainInput.value = this.value;
        mainInput.dispatchEvent(new Event('input'));

        if (this.value.trim() !== '') {
          if (resultWrapper) resultWrapper.classList.remove('unloaded');
          if (mainContent) mainContent.classList.add('unloaded');
          if (searchHints) searchHints.classList.add('unloaded');
        } else {
          if (resultWrapper) resultWrapper.classList.add('unloaded');
          if (mainContent) mainContent.classList.remove('unloaded');
          if (searchHints) searchHints.classList.remove('unloaded');
        }
      });

      sidebarInput.addEventListener('focus', function () {
        if (resultWrapper) resultWrapper.classList.remove('unloaded');
        if (mainContent) mainContent.classList.add('unloaded');
      });
    }
  })();
</script>